<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Coordinate Map with Categorized Material Filter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* Custom styles for Leaflet popup */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      background-color: #ffffff;
      padding: 0;
    }
    .leaflet-popup-content {
      margin: 0;
      padding: 16px;
      font-family: 'Arial', sans-serif;
    }
    .leaflet-popup-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
    }
    .leaflet-popup-content p {
      margin: 4px 0;
      font-size: 0.875rem;
      color: #374151;
    }
    .leaflet-popup-content p strong {
      color: #1f2937;
      font-weight: 500;
    }
    .leaflet-popup-tip {
      background-color: #ffffff;
    }
    /* Custom styles for Select2 */
    .select2-container .select2-selection--multiple {
      border: 1px solid #d1d5db;
      border-radius: 4px;
      min-height: 38px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__rendered {
      padding: 4px 8px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #e5e7eb;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 2px 8px;
      margin: 2px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
      color: #6b7280;
      margin-right: 4px;
    }
    .select2-container {
      width: 100% !important;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Construction Coordinate Map with Material Type Filter</h1>
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700">Upload CSV File</label>
      <input type="file" id="fileInput" accept=".csv" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
    </div>
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700">Filter by Material Type</label>
      <select id="materialTypeFilter" multiple class="mt-1 block w-full"></select>
    </div>
    <div class="mb-4">
      <p class="text-sm text-gray-600">Click on the map to show markers within a 10-mile radius. Click a marker to see facility and contact details. <button id="resetView" class="text-blue-500 underline">Reset</button></p>
    </div>
    <div id="map" class="h-96 w-full mt-4"></div>
  </div>

  <script>
    const materialTypeCategories = {
      "Concrete & Cement": [
        "Cement",
        "Non Structural Concrete",
        "Structural Concrete",
        "Prestressed Concrete Products",
        "Precast Pipe",
        "Precast Drainage Structures",
        "Incidental Precast Products"
      ],
      "Asphalt & Binders": [
        "Asphalt",
        "Asphalt Binder",
        "Asphalt Emulsions",
        "Ground Tire Rubber"
      ],
      "Steel & Metal": [
        "Metal Pipe",
        "Steel Bridge (Pedestrian)",
        "Steel Bridge (Vehicular)",
        "Steel Modular Joints",
        "Shop Metalizing",
        "Shop Painting",
        "Bridge Bearings",
        "Bridge Castings",
        "Bridge Forgings",
        "Bridge Machinery",
        "Guardrail"
      ],
      "Polymers & Additives": [
        "Fiber Reinforced Polymers",
        "Fly Ash",
        "Ultra Fine Fly Ash",
        "Silica Fume",
        "GGBF Slag",
        "Metakaolin"
      ],
      "Structures & Overhead": [
        "Overhead Cantilever",
        "Overhead Gantry",
        "Overhead Monotube",
        "Overhead Span/Truss"
      ],
      "Plastic & Timber": [
        "Plastic Pipe",
        "Timber"
      ],
      "Aggregate": [
        "Aggregate"
      ],
      "Other": []
    };

    // initialize material type selector
    const materialSelect = $('#materialTypeFilter');
    $(document).ready(function() {
      Object.entries(materialTypeCategories).forEach(([category, types]) => {
        const group = $('<optgroup>').attr('label', category);
        types.forEach(type => {
          group.append($('<option>').val(type).text(type));
        });
        materialSelect.append(group);
      });
      materialSelect.select2({ placeholder: 'Select material types' });
    });

    // create map
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const markers = [];

    // handle CSV upload
    document.getElementById('fileInput').addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: results => loadMarkers(results.data)
      });
    });

    function loadMarkers(data) {
      markers.forEach(m => map.removeLayer(m));
      markers.length = 0;

      data.forEach(row => {
        const lat = parseFloat(row.Latitude || row.lat || row.latitude);
        const lng = parseFloat(row.Longitude || row.lon || row.lng || row.longitude);
        if (isNaN(lat) || isNaN(lng)) return;
        const marker = L.marker([lat, lng]);
        marker.materialType = row['Material Type'] || row.MaterialType || row.material_type || 'Other';
        const facility = row.Facility || row.Name || '';
        const contact = row.Contact || row.ContactName || '';
        const phone = row.Phone || '';
        let popup = `<h3>${facility}</h3>`;
        if (contact) popup += `<p><strong>Contact:</strong> ${contact}</p>`;
        if (phone) popup += `<p><strong>Phone:</strong> ${phone}</p>`;
        marker.bindPopup(popup);
        marker.addTo(map);
        markers.push(marker);
      });
      filterMarkers();
    }

    function filterMarkers() {
      const selected = materialSelect.val() || [];
      markers.forEach(marker => {
        if (selected.length === 0 || selected.includes(marker.materialType)) {
          marker.addTo(map);
        } else {
          map.removeLayer(marker);
        }
      });
    }

    materialSelect.on('change', filterMarkers);

    map.on('click', e => {
      const radiusMeters = 10 * 1609.34;
      const clickLatLng = e.latlng;
      const circle = L.circle(clickLatLng, { radius: radiusMeters, color: '#2563eb' }).addTo(map);
      const within = markers.filter(m => clickLatLng.distanceTo(m.getLatLng()) <= radiusMeters);
      markers.forEach(m => map.removeLayer(m));
      within.forEach(m => m.addTo(map));
      setTimeout(() => map.removeLayer(circle), 2000);
    });

    document.getElementById('resetView').addEventListener('click', () => {
      map.setView([39.8283, -98.5795], 4);
      filterMarkers();
    });
  </script>
</body>
</html>
