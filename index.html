<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Coordinate Map with Categorized Material Filter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* Custom styles for Leaflet popup */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      background-color: #ffffff;
      padding: 0;
    }
    .leaflet-popup-content {
      margin: 0;
      padding: 16px;
      font-family: 'Arial', sans-serif;
    }
    .leaflet-popup-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
    }
    .leaflet-popup-content p {
      margin: 4px 0;
      font-size: 0.875rem;
      color: #374151;
    }
    .leaflet-popup-content p strong {
      color: #1f2937;
      font-weight: 500;
    }
    .leaflet-popup-tip {
      background-color: #ffffff;
    }
    /* Custom styles for Select2 */
    .select2-container .select2-selection--multiple {
      border: 1px solid #d1d5db;
      border-radius: 4px;
      min-height: 38px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__rendered {
      padding: 4px 8px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #e5e7eb;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 2px 8px;
      margin: 2px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
      color: #6b7280;
      margin-right: 4px;
    }
    .select2-container {
      width: 100% !important;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Construction Coordinate Map with Material Type Filter</h1>
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700">Upload CSV File</label>
      <input type="file" id="fileInput" accept=".csv" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
    </div>
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700">Filter by Material Type</label>
      <select id="materialTypeFilter" multiple class="mt-1 block w-full"></select>
    </div>
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700">Search Radius: <span id="radiusValue">10</span> miles</label>
      <input type="range" id="radiusSlider" min="1" max="50" value="10" class="w-full">
    </div>
    <div class="mb-4">
      <p class="text-sm text-gray-600">Click on the map to choose a location. Markers within the selected radius will appear. <button id="resetView" class="text-blue-500 underline">Reset</button></p>
    </div>
    <div id="map" class="h-96 w-full mt-4"></div>
  </div>

  <script>
    const materialTypeCategories = {
      "Concrete & Cement": [
        "Cement",
        "Non Structural Concrete",
        "Structural Concrete",
        "Prestressed Concrete Products",
        "Precast Pipe",
        "Precast Drainage Structures",
        "Incidental Precast Products"
      ],
      "Asphalt & Binders": [
        "Asphalt",
        "Asphalt Binder",
        "Asphalt Emulsions",
        "Ground Tire Rubber"
      ],
      "Steel & Metal": [
        "Metal Pipe",
        "Steel Bridge (Pedestrian)",
        "Steel Bridge (Vehicular)",
        "Steel Modular Joints",
        "Shop Metalizing",
        "Shop Painting",
        "Bridge Bearings",
        "Bridge Castings",
        "Bridge Forgings",
        "Bridge Machinery",
        "Guardrail"
      ],
      "Polymers & Additives": [
        "Fiber Reinforced Polymers",
        "Fly Ash",
        "Ultra Fine Fly Ash",
        "Silica Fume",
        "GGBF Slag",
        "Metakaolin"
      ],
      "Structures & Overhead": [
        "Overhead Cantilever",
        "Overhead Gantry",
        "Overhead Monotube",
        "Overhead Span/Truss"
      ],
      "Plastic & Timber": [
        "Plastic Pipe",
        "Timber"
      ],
      "Aggregate": [
        "Aggregate"
      ],
      "Other": []
    };
  </script>
<script>
let map = L.map('map').setView([28, -82], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let radiusCircle;
const metersPerMile = 1609.34;
let searchRadius = 10 * metersPerMile;
let selectedLatLng = null;

function addMarkers(rows) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  rows.forEach(row => {
    const lat = parseFloat(row.Latitude);
    const lng = parseFloat(row.Longitude);
    if (isNaN(lat) || isNaN(lng)) return;
    const marker = L.marker([lat, lng]);
    marker.material = row['Material Type'];
    const popup = `<h3>${row.Company || ''}</h3>` +
      `<p><strong>Facility:</strong> ${row['Facility Description'] || ''}</p>` +
      `<p><strong>Material:</strong> ${row['Material Type'] || ''}</p>` +
      `<p><strong>Contact:</strong> ${row['Contact Person'] || ''}</p>`;
    marker.bindPopup(popup);
    markers.push(marker);
  });
  updateMarkers();
}

function updateMarkers() {
  markers.forEach(m => map.removeLayer(m));
  if (!selectedLatLng) return;
  const types = $('#materialTypeFilter').val() || [];
  markers.forEach(m => {
    const inType = !types.length || types.includes(m.material);
    const inRadius = selectedLatLng.distanceTo(m.getLatLng()) <= searchRadius;
    if (inType && inRadius) {
      m.addTo(map);
    }
  });
}

document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: res => addMarkers(res.data)
  });
});

$(document).ready(function () {
  const $select = $('#materialTypeFilter');
  for (const [group, opts] of Object.entries(materialTypeCategories)) {
    const $group = $('<optgroup>').attr('label', group);
    opts.forEach(v => $group.append($('<option>').val(v).text(v)));
    $select.append($group);
  }
  $select.select2();
  $select.on('change', () => updateMarkers());
  const slider = document.getElementById('radiusSlider');
  const radiusText = document.getElementById('radiusValue');
  slider.addEventListener('input', () => {
    radiusText.textContent = slider.value;
    searchRadius = slider.value * metersPerMile;
    if (radiusCircle) radiusCircle.setRadius(searchRadius);
    updateMarkers();
  });
});

map.on('click', e => {
  selectedLatLng = e.latlng;
  if (radiusCircle) map.removeLayer(radiusCircle);
  radiusCircle = L.circle(e.latlng, { radius: searchRadius });
  radiusCircle.addTo(map);
  updateMarkers();
});

document.getElementById('resetView').addEventListener('click', () => {
  if (radiusCircle) map.removeLayer(radiusCircle);
  selectedLatLng = null;
  updateMarkers();
});
</script>
</body>
</html>
